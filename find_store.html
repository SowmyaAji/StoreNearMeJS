<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>StoreNearMe</title>
    <link rel="stylesheet" href="find_store.css">
    <link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
    <script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
    
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.0/jquery.min.js"></script>
  
</head>

<body>
    <header>
        <h1>StoreNearMe</h1>
    </header>
    <div><input type="text" id="addr" placeholder="Enter your address"><button id="addbtn">Go</button>
    
    <br>
    <div id="mapid"></div>

</body>
 
<script>
let initialLatLng = [35.9957436, -78.9012117]
let mymap = L.map('mapid').setView(initialLatLng, 11);

const osm = L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
    attribution: '&copy; <a href="http://osm.org/copyright">OpenStreetMap</a> contributors'

}).addTo(mymap);
let mylatLng = [35.966045, -78.9587215]
let marker = L.marker(mylatLng).addTo(mymap);
marker.setLatLng(mylatLng).update();
marker.bindPopup("<b>Hi! I am the nearest store!").openPopup();
function getAdd() {
    $("#addbtn").on('click', function () {
        myFetch($("#addr").val())
    })
}
getAdd()

function myFetch(address) {
    const proxyUrl = 'https://cors-anywhere.herokuapp.com/';
    const queryUrl = encodeURI('http://photon.komoot.de/api/?limit=1&q=' + address)
    fetch(proxyUrl + queryUrl)
        .then(blob => blob.json())
        .then(data => {
            let addLat = data.features[0].geometry.coordinates[1]
            addLat = parseFloat(addLat)
            let addLong = data.features[0].geometry.coordinates[0]
            addLong = parseFloat(addLong)
            getStoreLocs(addLat, addLong)
        })
}

function getStoreLocs(addLat, addLong) {
    let url = 'parsed.json';
    $.getJSON(url, function (json) {
        let storeArr = json;
        findNearest(addLat, addLong, storeArr)
    })
}
getStoreLocs()

function findNearest(addLat, addLong, storeArr) {
    let distance = null;
    let nearest = null;
    let latLong = [];

    storeArr.forEach((location) => {
        let storeLat = (location['Latitude'])
        storeLat = parseFloat(storeLat)
        let storeLong = (location['Longitude'])
        storeLong = parseFloat(storeLong)
        let dist = getDistance(addLat, addLong, storeLat, storeLong)
        dist = parseFloat(dist);
        if (distance === null || dist < distance) {
            distance = dist;
            distance = parseFloat(distance)
            nearest = location;
            latLong = [storeLat, storeLong]
        }
    })
    let addLatLong = [addLat, addLong]
    initialLatLong = addLatLong
    console.log(nearest, distance, latLong, addLatLong)
    mylatLng = latLong
    marker.setLatLng(mylatLng).update();
    map.setView(new L.LatLng(addLatLong), 8);
    console.log(mylatLng)
    let newContent = nearest
    marker.setPopupContent(newContent)
    // return {
    //     addLatLong: addLatLong,
    //     location: nearest, distance: distance, latLong: latLong
    // }
}

function getDistance(lat1, lon1, lat2, lon2, unit = "M") {
    if ((lat1 === lat2) && (lon1 === lon2)) {
        return 0;
    }
    else {
        let radlat1 = Math.PI * lat1 / 180;
        let radlat2 = Math.PI * lat2 / 180;
        let theta = lon1 - lon2;
        let radtheta = Math.PI * theta / 180;
        let dist = Math.sin(radlat1) * Math.sin(radlat2) + Math.cos(radlat1) * Math.cos(radlat2) * Math.cos(radtheta);
        if (dist > 1) {
            dist = 1;
        }
        dist = Math.acos(dist);
        dist = dist * 180 / Math.PI;
        dist = dist * 60 * 1.1515;
        if (unit === "K") { dist = dist * 1.609344 }
        if (unit === "N") { dist = dist * 0.8684 }
        return dist;
    }
}


</script>




</html>